<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pixel Focus OS (Offline)</title>
    
    <script src="./assets/tailwindcss.js"></script>
    <script src="./assets/react.development.js"></script>
    <script src="./assets/react-dom.development.js"></script>
    <script src="./assets/babel.min.js"></script>

    <style>
      /* Local Font Definition */
      @font-face {
        font-family: 'VT323';
        src: url('./assets/VT323-Regular.ttf') format('truetype');
      }
      /* Custom styles for the range input */
      input[type=range] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type=range]:focus {
        outline: none;
      }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 12px;
        cursor: pointer;
        background: var(--color-text);
        border: 2px solid var(--color-text);
      }
      input[type=range]::-webkit-slider-thumb {
        border: 4px solid var(--color-text);
        height: 24px;
        width: 12px;
        background: var(--color-accent);
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -10px;
      }
      /* Plant Animation */
      @keyframes gentle-sway {
        0%, 100% {
          transform: rotate(-1deg);
        }
        50% {
          transform: rotate(1deg);
        }
      }
      .plant-sway {
        animation: gentle-sway 5s ease-in-out infinite;
      }
    </style>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              mono: ['VT323', 'monospace'],
            },
            colors: {
              bg: 'var(--color-bg)',
              text: 'var(--color-text)',
              card: 'var(--color-card)',
              accent: 'var(--color-accent)',
              'accent-hover': 'var(--color-accent-hover)',
              white: '#FFFFFF',
              black: '#000000',
              'red-500': '#ef4444',
              'blue-500': '#3b82f6',
              'pink-500': '#ec4899',
              'yellow-500': '#eab308',
              'purple-500': '#8b5cf6',
              'green-500': '#22c55e',
              'orange-500': '#f97316',
            },
          },
        },
      }
    </script>
</head>
<body class="font-mono">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONTEXT DEFINITIONS ---
        const ThemeContext = React.createContext();
        const SFXContext = React.createContext();

        // --- CUSTOM HOOKS ---
        const useLocalStorage = (key, initialValue) => {
          const [storedValue, setStoredValue] = React.useState(() => {
            try {
              const item = window.localStorage.getItem(key);
              return item ? JSON.parse(item) : initialValue;
            } catch (error) { console.error(error); return initialValue; }
          });

          const setValue = (value) => {
            try {
              const valueToStore = value instanceof Function ? value(storedValue) : value;
              setStoredValue(valueToStore);
              window.localStorage.setItem(key, JSON.stringify(valueToStore));
            } catch (error) { console.error(error); }
          };
          return [storedValue, setValue];
        };

        const useTheme = () => React.useContext(ThemeContext);
        const useSFX = () => React.useContext(SFXContext);

        // --- CONSTANTS ---
        const POMODORO_DURATIONS = { 'Focus': 25 * 60, 'Short Break': 5 * 60, 'Long Break': 15 * 60 };

        const THEMES = {
            'PixelOS': { bg: '#283238', text: '#B6C2BF', card: '#38454C', accent: '#6AB0A2', 'accent-hover': '#548C7F' },
            'Paper': { bg: '#C7D3D1', text: '#283238', card: '#B6C2BF', accent: '#4A7A71', 'accent-hover': '#3A615A' },
            'Dungeon': { bg: '#2d232e', text: '#b1a4a5', card: '#453747', accent: '#9b63a3', 'accent-hover': '#7e5084' },
            'Ocean': { bg: '#1a3a4a', text: '#a6c3d1', card: '#2a5b74', accent: '#4aa9d5', 'accent-hover': '#3b87ab' },
            'Sunset': { bg: '#4f2343', text: '#eac0a8', card: '#703a5c', accent: '#ff8b61', 'accent-hover': '#d97552' },
        };
        const THEME_NAMES = Object.keys(THEMES);

        const TAG_COLORS = {
            'Health': 'bg-red-500', 'Character': 'bg-blue-500', 'Relationships': 'bg-pink-500', 'Education': 'bg-yellow-500 text-black', 'Aspirations': 'bg-purple-500', 'Money': 'bg-green-500', 'Family': 'bg-orange-500',
        };

        const PIXEL_BORDER_STYLE = "border-4 border-text";
        const PIXEL_BUTTON_STYLE = `${PIXEL_BORDER_STYLE} px-4 py-2 transition-all active:translate-y-0.5 active:translate-x-0.5`;
        
        const GoalTag = { Health: 'Health', Character: 'Character', Relationships: 'Relationships', Education: 'Education', Aspirations: 'Aspirations', Money: 'Money', Family: 'Family' };
        const PomodoroState = { Focus: 'Focus', ShortBreak: 'Short Break', LongBreak: 'Long Break' };

        // --- PROVIDERS ---
        const ThemeProvider = ({ children }) => {
          const [theme, setTheme] = useLocalStorage('theme', 'PixelOS');

          React.useEffect(() => {
            const newTheme = THEMES[theme];
            const root = document.documentElement;
            Object.entries(newTheme).forEach(([key, value]) => {
              root.style.setProperty(`--color-${key}`, value);
            });
          }, [theme]);

          const cycleTheme = () => {
            const currentIndex = THEME_NAMES.indexOf(theme);
            const nextIndex = (currentIndex + 1) % THEME_NAMES.length;
            setTheme(THEME_NAMES[nextIndex]);
          };

          return <ThemeContext.Provider value={{ theme, cycleTheme }}>{children}</ThemeContext.Provider>;
        };

        const SFXProvider = ({ children }) => {
            const [sfxEnabled, setSfxEnabled] = useLocalStorage('sfxEnabled', true);
            const clickSoundRef = React.useRef(null);

            React.useEffect(() => {
                clickSoundRef.current = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAJABAAAAAEAIAA+AAAAAAsAAAACAAgAZGF0YSQAAAAADgCQAIgCSgLHAs8C/wL/A/gE/gUEBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIBgYIA==");
                clickSoundRef.current.volume = 0.5;
            }, []);

            const playClick = () => {
                if (sfxEnabled && clickSoundRef.current) {
                    clickSoundRef.current.currentTime = 0;
                    clickSoundRef.current.play();
                }
            };
            
            const toggleSfx = () => setSfxEnabled(prev => !prev);

            return <SFXContext.Provider value={{ sfxEnabled, toggleSfx, playClick }}>{children}</SFXContext.Provider>;
        };


        // --- HELPER COMPONENTS & ICONS ---
        const PlayIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5V19L19 12L8 5Z" /></svg>;
        const PauseIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z" /></svg>;
        const ResetIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6L12 11V7C15.31 7 18 9.69 18 13C18 16.31 15.31 19 12 19C8.69 19 6 16.31 6 13H4C4 17.42 7.58 21 12 21C16.42 21 20 17.42 20 13C20 8.58 16.42 5 12 5Z" /></svg>;
        const PlusIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>;
        const SoundOnIcon = () => <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>;
        const SoundOffIcon = () => <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>;

        // --- ENHANCED PLANT COMPONENT ---
        const PixelPlant = () => {
            return (
                <div className={`p-4 ${PIXEL_BORDER_STYLE} bg-card h-full flex flex-col items-center justify-center`}>
                    <h2 className="text-xl mb-4">PIXEL PLANT</h2>
                    <div className="w-48 h-48 p-2 bg-bg border-4 border-text flex items-center justify-center">
                        <svg viewBox="0 0 48 48" className="w-full h-full plant-sway" style={{ transformOrigin: 'bottom center' }}>
                            <path fill="currentColor" d="M22 6H26V10H22V6M30 10H26V14H22V18H18V22H14V30H18V26H22V22H26V18H30V14H34V10H30M18 18H22V14H26V10H30V6H26V2H22V6H18V10H14V14H18V18M14 26H10V22H14V26M34 22H30V26H34V22M18 30H22V34H18V30M26 34H30V30H26V34M18 38H30V34H18V38M14 42H34V38H14V42Z"/>
                        </svg>
                    </div>
                </div>
            );
        };

        // --- CLOCK & PROGRESS COMPONENTS ---
        const SegmentedProgressBar = ({ current, total, segments = 30 }) => {
            const progress = total > 0 ? (current / total) * 100 : 0;
            const activeSegments = Math.round((progress / 100) * segments);
            return (
                <div className="flex space-x-1 w-full">
                    {Array.from({ length: segments }).map((_, i) => (
                        <div key={i} className={`flex-1 h-4 ${i < activeSegments ? 'bg-accent' : 'bg-text/20'}`}></div>
                    ))}
                </div>
            );
        };
        const GlobalProgressBar = ({ label, value}) => {
            return (
                <div>
                    <div className="flex justify-between text-sm"><p>{label}</p><p>{value.toFixed(0)}%</p></div>
                    <div className="flex space-x-0.5 w-full h-3 bg-text/20 p-0.5 border border-text">
                        <div className="bg-accent" style={{width: `${value}%`}}></div>
                    </div>
                </div>
            )
        }

        const PixelClock = ({ seconds, initialSeconds }) => {
          const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
          const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
          const s = String(seconds % 60).padStart(2, '0');
          return (
            <div className="flex flex-col items-center">
                <h1 className="text-8xl md:text-9xl font-mono">{`${h}:${m}:${s}`}</h1>
                <SegmentedProgressBar current={seconds} total={initialSeconds} />
            </div>
          );
        };

        const useTimeProgress = () => {
            const [progress, setProgress] = React.useState({ day: 0, week: 0, month: 0, year: 0 });
            React.useEffect(() => {
                const updateProgress = () => {
                    const now = new Date();
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const startOfWeek = new Date(startOfDay);
                    startOfWeek.setDate(startOfWeek.getDate() - now.getDay());
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    
                    const secondsInDay = 24 * 60 * 60;
                    const msInDay = secondsInDay * 1000;
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const daysInYear = (now.getFullYear() % 4 === 0 && now.getFullYear() % 100 !== 0) || now.getFullYear() % 400 === 0 ? 366 : 365;

                    const dayProgress = ((now.getTime() - startOfDay.getTime()) / msInDay) * 100;
                    const weekProgress = ((now.getDay() * secondsInDay + (now.getTime() - startOfDay.getTime())/1000) / (7 * secondsInDay)) * 100;
                    const monthProgress = (((now.getDate()-1) * msInDay + (now.getTime() - startOfDay.getTime())) / (daysInMonth * msInDay)) * 100;
                    const yearProgress = ((now.getTime() - startOfYear.getTime()) / (daysInYear * msInDay)) * 100;

                    setProgress({ day: dayProgress, week: weekProgress, month: monthProgress, year: yearProgress });
                };
                updateProgress();
                const interval = setInterval(updateProgress, 60000); // Update every minute
                return () => clearInterval(interval);
            }, []);
            return progress;
        };

        // --- UI COMPONENTS ---
        const ThemeSwitcher = () => {
          const { cycleTheme } = useTheme();
          const { playClick } = useSFX();
          return <button onClick={() => { playClick(); cycleTheme(); }} className={`${PIXEL_BUTTON_STYLE} bg-card`}>THEME</button>;
        };

        const SFXToggle = () => {
            const { sfxEnabled, toggleSfx, playClick } = useSFX();
            return <button onClick={() => { playClick(); toggleSfx(); }} className={`${PIXEL_BUTTON_STYLE} bg-card`}>{sfxEnabled ? <SoundOnIcon /> : <SoundOffIcon />}</button>
        }

        const BrownNoisePlayer = () => {
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [preset, setPreset] = useLocalStorage('noise_preset', 'Medium');
            const [volume, setVolume] = useLocalStorage('noise_volume', 0.2);
            const { playClick } = useSFX();

            const audioContextRef = React.useRef(null);
            const sourceNodeRef = React.useRef(null);
            const gainNodeRef = React.useRef(null);

            const filterFrequencies = { 'Deep': 300, 'Medium': 500, 'Light': 800 };

            const startNoise = React.useCallback(() => {
                if (!audioContextRef.current) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioContextRef.current = new AudioContext();
                }
                const audioContext = audioContextRef.current;
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                if (sourceNodeRef.current) {
                    sourceNodeRef.current.stop();
                }

                const bufferSize = audioContext.sampleRate * 2;
                const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }

                sourceNodeRef.current = audioContext.createBufferSource();
                sourceNodeRef.current.buffer = buffer;
                sourceNodeRef.current.loop = true;

                const filterNode = audioContext.createBiquadFilter();
                filterNode.type = 'lowpass';
                filterNode.frequency.value = filterFrequencies[preset];

                gainNodeRef.current = audioContext.createGain();
                gainNodeRef.current.gain.setValueAtTime(volume, audioContext.currentTime);

                sourceNodeRef.current.connect(filterNode).connect(gainNodeRef.current).connect(audioContext.destination);
                sourceNodeRef.current.start();
                setIsPlaying(true);
            }, [preset, volume]);

            const stopNoise = React.useCallback(() => {
                if (sourceNodeRef.current) {
                    sourceNodeRef.current.stop();
                    sourceNodeRef.current = null;
                }
                setIsPlaying(false);
            }, []);

            const togglePlay = () => {
                playClick();
                isPlaying ? stopNoise() : startNoise();
            };
            
            React.useEffect(() => {
                if (isPlaying) {
                    startNoise();
                }
            }, [preset, startNoise, isPlaying]);

            React.useEffect(() => {
                if (gainNodeRef.current && audioContextRef.current) {
                    gainNodeRef.current.gain.setValueAtTime(volume, audioContextRef.current.currentTime);
                }
            }, [volume]);

            return (
                <div className="w-full">
                    <div className="flex items-center space-x-2">
                        <button onClick={togglePlay} className={`${PIXEL_BUTTON_STYLE} bg-card`} aria-label="Toggle Noise">
                            {isPlaying ? <SoundOnIcon /> : <SoundOffIcon />}
                        </button>
                         <div className={`${PIXEL_BORDER_STYLE} bg-card flex`}>
                            {['Deep', 'Medium', 'Light'].map(p => 
                                <button key={p} onClick={() => { playClick(); setPreset(p); }} className={`px-2 py-1 text-sm ${p === preset ? 'bg-accent text-white' : ''}`}>
                                    {p.toUpperCase()}
                                </button>
                            )}
                        </div>
                    </div>
                    <div className="mt-4">
                        <input type="range" min="0" max="0.5" step="0.01" value={volume} onChange={e => setVolume(parseFloat(e.target.value))} className="w-full" />
                    </div>
                </div>
            )
        };
        const GlobalProgressBars = () => {
            const {day, week, month, year} = useTimeProgress();
            return (
                <div className="w-full space-y-2 mt-6">
                    <GlobalProgressBar label="DAY" value={day} />
                    <GlobalProgressBar label="WEEK" value={week} />
                    <GlobalProgressBar label="MONTH" value={month} />
                    <GlobalProgressBar label="YEAR" value={year} />
                </div>
            )
        }

        const TodoItem = ({ todo, onToggle, onDelete }) => (
            <li className="flex items-center p-2 bg-bg">
                <input type="checkbox" checked={todo.completed} onChange={() => onToggle(todo.id)} className={`w-5 h-5 mr-3 appearance-none ${PIXEL_BORDER_STYLE} checked:bg-accent`} />
                <span className={`flex-grow ${todo.completed ? 'line-through text-text/60' : ''}`}>{todo.text}</span>
                <button onClick={() => onDelete(todo.id)} className="ml-2 text-red-500">X</button>
            </li>
        );

        const TodoList = ({ todos, setTodos, selectedDate }) => {
            const [newTodo, setNewTodo] = React.useState('');
            const { playClick } = useSFX();
            const dateString = selectedDate.toISOString().split('T')[0];

            const addTodo = () => {
                if (newTodo.trim()) {
                    playClick();
                    setTodos(prev => [{ id: Date.now().toString(), text: newTodo.trim(), completed: false, date: dateString }, ...prev]);
                    setNewTodo('');
                }
            };
            
            const toggleTodo = (id) => setTodos(todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            const deleteTodo = (id) => setTodos(todos.filter(t => t.id !== id));
            
            return (
                <div className={`p-4 ${PIXEL_BORDER_STYLE} bg-card h-full flex flex-col`}>
                    <h2 className="text-xl mb-2">TASKS FOR: {selectedDate.toLocaleDateString()}</h2>
                    <div className="flex mb-4">
                        <input type="text" value={newTodo} onChange={e => setNewTodo(e.target.value)} onKeyDown={e => e.key === 'Enter' && addTodo()} placeholder="New task..." className={`flex-grow p-2 bg-bg ${PIXEL_BORDER_STYLE} focus:outline-none`} />
                        <button onClick={addTodo} className={`${PIXEL_BUTTON_STYLE} bg-accent text-white`}><PlusIcon /></button>
                    </div>
                    <ul className="space-y-2 overflow-y-auto flex-grow">{todos.filter(t => t.date === dateString).map(todo => <TodoItem key={todo.id} todo={todo} onToggle={toggleTodo} onDelete={deleteTodo} />)}</ul>
                </div>
            );
        };

        const Calendar = ({ selectedDate, setSelectedDate, todos }) => {
            const [displayDate, setDisplayDate] = React.useState(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1));
            const { playClick } = useSFX();

            const changeMonth = (offset) => {
                playClick();
                setDisplayDate(prev => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
            }
            const { year, month } = { year: displayDate.getFullYear(), month: displayDate.getMonth() };
            const days = Array.from({ length: new Date(year, month + 1, 0).getDate() }, (_, i) => i + 1);
            const blanks = Array.from({ length: new Date(year, month, 1).getDay() });
            
            return (
                <div className={`p-4 ${PIXEL_BORDER_STYLE} bg-card`}>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => changeMonth(-1)} className={PIXEL_BUTTON_STYLE}>&lt;</button>
                        <h2 className="text-lg">{displayDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => changeMonth(1)} className={PIXEL_BUTTON_STYLE}>&gt;</button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center">
                        {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => <div key={`${d}-${i}`}>{d}</div>)}
                        {blanks.map((_, i) => <div key={`b-${i}`}></div>)}
                        {days.map(day => {
                            const isSelected = selectedDate.getDate() === day && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                            const hasTasks = todos.some(t => t.date === new Date(year, month, day).toISOString().split('T')[0] && !t.completed);
                            return (<button key={day} onClick={() => { playClick(); setSelectedDate(new Date(year, month, day)); }} className={`relative w-8 h-8 ${isSelected ? 'bg-accent text-white' : ''} ${hasTasks ? 'font-bold' : ''}`}>{day}</button>)
                        })}
                    </div>
                </div>
            );
        };

        const ProgressTracker = ({ progress }) => {
            const [view, setView] = React.useState('Weekly');
            const { playClick } = useSFX();
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            const renderView = () => {
                switch (view) {
                    case 'Daily':
                        const todayCount = progress[todayStr] || 0;
                        return <div className="text-center p-4">
                            <h3 className="text-lg">TODAY'S FOCUS</h3>
                            <div className={`mt-2 p-4 text-4xl ${PIXEL_BORDER_STYLE} ${todayCount > 0 ? 'bg-accent text-white' : 'bg-bg'}`}>{todayCount} {todayCount === 1 ? 'SESSION' : 'SESSIONS'}</div>
                        </div>;
                    case 'Weekly':
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(today.getDate() - today.getDay());
                        return <div className="p-4">
                            <h3 className="text-lg text-center mb-2">THIS WEEK</h3>
                            <div className="grid grid-cols-7 gap-2">
                                {Array.from({length: 7}).map((_, i) => {
                                    const day = new Date(startOfWeek);
                                    day.setDate(startOfWeek.getDate() + i);
                                    const dayStr = day.toISOString().split('T')[0];
                                    const dayCount = progress[dayStr] || 0;
                                    return <div key={i} title={`${day.toDateString()}: ${dayCount} sessions`} className={`h-10 ${PIXEL_BORDER_STYLE} flex items-center justify-center ${dayCount > 0 ? 'bg-accent' : 'bg-bg'}`}>{day.toLocaleDateString('en-US', {weekday: 'short'})[0]}</div>
                                })}
                            </div>
                        </div>;
                    case 'Monthly':
                        const year = today.getFullYear();
                        const month = today.getMonth();
                        const monthlyEntries = Object.entries(progress).filter(([date]) => new Date(date).getFullYear() === year && new Date(date).getMonth() === month);
                        const totalSessions = monthlyEntries.reduce((sum, [, count]) => sum + count, 0);
                        const daysWithSessions = monthlyEntries.length;
                        const averageSessions = daysWithSessions > 0 ? (totalSessions / daysWithSessions).toFixed(1) : 0;
                        const mostProductive = monthlyEntries.sort((a,b) => b[1] - a[1])[0];
                         return <div className="p-4 text-center">
                            <h3 className="text-lg mb-2">{today.toLocaleString('default', { month: 'long' }).toUpperCase()} SUMMARY</h3>
                            <div className="space-y-2">
                                <p>TOTAL SESSIONS: <span className="font-bold text-accent">{totalSessions}</span></p>
                                <p>PRODUCTIVE DAYS: <span className="font-bold text-accent">{daysWithSessions}</span></p>
                                <p>DAILY AVERAGE: <span className="font-bold text-accent">{averageSessions}</span></p>
                                {mostProductive && <p>BEST DAY: <span className="font-bold text-accent">{new Date(mostProductive[0]).toLocaleDateString()} ({mostProductive[1]} sessions)</span></p>}
                            </div>
                        </div>;
                }
            };
            
            return (
                <div className={`p-4 ${PIXEL_BORDER_STYLE} bg-card`}>
                    <div className="flex justify-center border-b-4 border-text mb-2">
                        {['Daily', 'Weekly', 'Monthly'].map(v => 
                            <button key={v} onClick={() => { playClick(); setView(v); }} className={`px-4 py-1 text-lg ${view === v ? 'bg-accent text-white' : ''}`}>{v.toUpperCase()}</button>
                        )}
                    </div>
                    {renderView()}
                </div>
            );
        };
        const GoalsPanel = ({ goals, setGoals }) => {
            const [period, setPeriod] = React.useState('Daily');
            const [newGoal, setNewGoal] = React.useState('');
            const [selectedTags, setSelectedTags] = React.useState([]);
            const { playClick } = useSFX();
            
            const addGoal = () => {
                if (!newGoal.trim()) return;
                playClick();
                setGoals(prev => [{id: Date.now().toString(), text: newGoal.trim(), completed: false, period, tags: selectedTags}, ...prev]);
                setNewGoal('');
                setSelectedTags([]);
            };
            const toggleTag = (tag) => {
                playClick();
                setSelectedTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]);
            }
            const toggleGoal = (id) => setGoals(goals.map(g => g.id === id ? {...g, completed: !g.completed} : g));
            const deleteGoal = (id) => setGoals(goals.filter(g => g.id !== id));

            return (
                <div className={`p-4 ${PIXEL_BORDER_STYLE} bg-card h-full flex flex-col`}>
                     <h2 className="text-xl mb-2">MISSION CONTROL</h2>
                     <div className="flex border-b-4 border-text mb-2">
                        {['Daily', 'Weekly', 'Monthly', 'Yearly'].map(p => 
                            <button key={p} onClick={() => { playClick(); setPeriod(p); }} className={`px-4 py-1 flex-1 ${period === p ? 'bg-accent text-white' : ''}`}>{p.toUpperCase()}</button>
                        )}
                     </div>
                     <div className="flex mb-4">
                         <input type="text" value={newGoal} onChange={e => setNewGoal(e.target.value)} onKeyDown={e => e.key === 'Enter' && addGoal()} placeholder="New mission..." className={`flex-grow p-2 bg-bg ${PIXEL_BORDER_STYLE} focus:outline-none`} />
                         <button onClick={addGoal} className={`${PIXEL_BUTTON_STYLE} bg-accent text-white`}><PlusIcon /></button>
                     </div>
                     <div className="flex flex-wrap gap-1 mb-4">
                        {Object.values(GoalTag).map(tag => <button key={tag} onClick={() => toggleTag(tag)} className={`px-2 py-0.5 text-xs ${TAG_COLORS[tag]} ${selectedTags.includes(tag) ? 'ring-2 ring-white' : ''}`}>{tag}</button>)}
                     </div>
                     <ul className="space-y-2 overflow-y-auto flex-grow">
                         {goals.filter(g => g.period === period).map(goal => (
                             <li key={goal.id} className="flex items-start p-2 bg-bg">
                                 <input type="checkbox" checked={goal.completed} onChange={() => toggleGoal(goal.id)} className={`w-5 h-5 mr-3 mt-1 appearance-none ${PIXEL_BORDER_STYLE} checked:bg-accent`}/>
                                 <div className="flex-grow">
                                    <span className={goal.completed ? 'line-through text-text/60' : ''}>{goal.text}</span>
                                    <div className="flex flex-wrap gap-1 mt-1">
                                        {goal.tags.map(tag => <span key={tag} className={`px-1.5 text-xs ${TAG_COLORS[tag]}`}>{tag}</span>)}
                                    </div>
                                 </div>
                                 <button onClick={() => deleteGoal(goal.id)} className="ml-2 text-red-500">X</button>
                             </li>
                         ))}
                     </ul>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [initialSeconds, setInitialSeconds] = React.useState(25 * 60);
            const [secondsLeft, setSecondsLeft] = React.useState(initialSeconds);
            const [isActive, setIsActive] = React.useState(false);
            
            const [pomodoroState, setPomodoroState] = React.useState(PomodoroState.Focus);
            const [pomodoroCount, setPomodoroCount] = React.useState(0);
            const [isPomodoroMode, setIsPomodoroMode] = React.useState(true);

            const [todos, setTodos] = useLocalStorage('todos', []);
            const [goals, setGoals] = useLocalStorage('goals', []);
            const [progress, setProgress] = useLocalStorage('progress', {});
            const [selectedDate, setSelectedDate] = React.useState(new Date());

            const { playClick } = useSFX();

            const notificationSoundRef = React.useRef(null);

            React.useEffect(() => {
                notificationSoundRef.current = new Audio("data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAA//uQ4AUAsAAAAAAAAAAB3e//uQ4AUAsAAAAAAAAAAB3e//uQ4AUAsAAAAAAAAAAB3e");
            }, []);

            const logFocusSession = React.useCallback(() => {
                const todayStr = new Date().toISOString().split('T')[0];
                setProgress(prev => ({ ...prev, [todayStr]: (prev[todayStr] || 0) + 1 }));
            }, [setProgress]);
            
            React.useEffect(() => {
                let interval = null;
                if (isActive && secondsLeft > 0) {
                    interval = setInterval(() => setSecondsLeft(s => s - 1), 1000);
                } else if (secondsLeft === 0 && isActive) {
                    setIsActive(false);
                    notificationSoundRef.current?.play();
                    if (pomodoroState === PomodoroState.Focus) logFocusSession();
                    if (isPomodoroMode) {
                        const newCount = pomodoroState === PomodoroState.Focus ? pomodoroCount + 1 : pomodoroCount;
                        setPomodoroCount(newCount);
                        let nextState = newCount % 4 === 0 ? PomodoroState.LongBreak : PomodoroState.ShortBreak;
                        if (pomodoroState !== PomodoroState.Focus) nextState = PomodoroState.Focus;
                        setPomodoroState(nextState);
                        const nextDuration = POMODORO_DURATIONS[nextState];
                        setInitialSeconds(nextDuration);
                        setSecondsLeft(nextDuration);
                        setIsActive(true);
                    }
                }
                return () => { if (interval) clearInterval(interval); };
            }, [isActive, secondsLeft, isPomodoroMode, pomodoroState, pomodoroCount, logFocusSession]);

            const handleSetTime = (mins) => {
                setIsActive(false);
                setIsPomodoroMode(false);
                const newTime = Math.max(1, mins) * 60;
                setInitialSeconds(newTime);
                setSecondsLeft(newTime);
            }
            
            const handlePomodoroSelect = (state) => {
                playClick();
                setIsActive(false);
                setIsPomodoroMode(true);
                setPomodoroState(state);
                const duration = POMODORO_DURATIONS[state];
                setInitialSeconds(duration);
                setSecondsLeft(duration);
            }

            const toggleTimerActive = () => { playClick(); setIsActive(!isActive); }
            const resetTimer = () => { playClick(); setIsActive(false); setSecondsLeft(initialSeconds); };
            const addFiveMinutes = () => { playClick(); setSecondsLeft(s => s + 300); if(!isPomodoroMode) setInitialSeconds(s => s + 300); }
            
            return (
                <div className="bg-bg text-text min-h-screen transition-colors duration-300 p-4 lg:p-8 text-lg">
                    <div className="max-w-7xl mx-auto">
                        <header className={`flex justify-between items-center mb-6 p-4 ${PIXEL_BORDER_STYLE} bg-card`}>
                            <h1 className="text-2xl lg:text-3xl">PIXEL FOCUS OS</h1>
                            <div className="flex items-center space-x-2">
                                <SFXToggle />
                                <ThemeSwitcher />
                            </div>
                        </header>

                        <main className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div className={`lg:col-span-3 p-6 ${PIXEL_BORDER_STYLE} bg-card flex flex-col items-center justify-center`}>
                                <div className="flex flex-wrap justify-center space-x-2 mb-4">
                                    {Object.values(PomodoroState).map(state => (
                                        <button key={state} onClick={() => handlePomodoroSelect(state)} className={`${PIXEL_BUTTON_STYLE} ${(isPomodoroMode && pomodoroState === state) ? 'bg-accent text-white' : 'bg-card'}`}>
                                            {state}
                                        </button>
                                    ))}
                                </div>
                                <PixelClock seconds={secondsLeft} initialSeconds={initialSeconds} />
                                <div className="flex flex-wrap justify-center items-center gap-4 mt-4">
                                    <button onClick={toggleTimerActive} className={`${PIXEL_BUTTON_STYLE} bg-accent text-white flex items-center gap-2`}>{isActive ? <><PauseIcon /> PAUSE</> : <><PlayIcon /> PLAY</>}</button>
                                    <button onClick={resetTimer} className={`${PIXEL_BUTTON_STYLE} bg-card flex items-center gap-2`}><ResetIcon /> RESET</button>
                                    <button onClick={addFiveMinutes} className={`${PIXEL_BUTTON_STYLE} bg-card flex items-center gap-2`}><PlusIcon /> +5 MINS</button>
                                </div>
                                 <div className="mt-6 flex items-center gap-2">
                                    <label>CUSTOM (MINS):</label>
                                    <input type="number" min="1" defaultValue={25} onChange={(e) => handleSetTime(Number(e.target.value))} className={`w-20 p-1 ${PIXEL_BORDER_STYLE} bg-bg text-center focus:outline-none`} />
                                </div>
                                <GlobalProgressBars />
                            </div>

                            <div className="lg:col-span-2 lg:row-span-2">
                                <GoalsPanel goals={goals} setGoals={setGoals} />
                            </div>

                            <div className="lg:col-span-3">
                                 <ProgressTracker progress={progress} />
                            </div>

                            <div className="lg:col-span-3">
                                <TodoList todos={todos} setTodos={setTodos} selectedDate={selectedDate} />
                            </div>

                            <div className="lg:col-span-2">
                                <PixelPlant />
                            </div>
                            
                            <div className="lg:col-span-3">
                                <Calendar selectedDate={selectedDate} setSelectedDate={setSelectedDate} todos={todos} />
                            </div>

                            <div className="lg:col-span-2 p-4 flex flex-col justify-center">
                                <BrownNoisePlayer />
                            </div>
                        </main>

                        <footer className="text-center text-sm py-4 mt-6 text-text/70">
                            Made by Navaneeth Sankar K P | nave.ethan1337@gmail.com
                        </footer>
                    </div>
                </div>
            );
        };

        // --- RENDER APPLICATION ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
          <React.StrictMode>
            <ThemeProvider>
                <SFXProvider>
                    <App />
                </SFXProvider>
            </ThemeProvider>
          </React.StrictMode>
        );

    </script>

</body>
</html>